import{a as j,e as A,f as m,q as x,h as D,r as p,j as e,i as I,C as f,S as y,N as S,m as h}from"./index-ByTeTk1v.js";import{t as g,s as v}from"./components-B0Y2GjJ0.js";async function O(n,l,o){l="Проаналізуй промпт та дату та дай конкретну відповідь на запитання на тій мові яка буде далі в промпті (якщо ангд то на англ очікую відповідь). Ще не роби ніяких таблиць чи виділень тексту (жирним чи іншим) чи формул - відповідь коротким абзацом тексту. Дозволяються смайли, небагато."+l;try{const a=await fetch("https://fintrack-4izg.onrender.com/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:n,prompt:l,model:o})});if(!a.ok)throw new Error(`Server error: ${a.statusText}`);return(await a.json()).result||"No response content"}catch(a){throw console.error("Analyze error:",a),a}}const w={prompt:"",response:null};function N(){const{user:n}=j(),l=localStorage.getItem("AI"),o=l?JSON.parse(l):w,{data:a}=A({queryKey:["AI"],queryFn:()=>o,staleTime:1/0,enabled:!!n}),d=m({mutationFn:async({prompt:s,model:i})=>{const r=await O(n?.data||[],s,i),t={forPrompt:s,id:D(),isNew:!0,content:r,date:new Date().toISOString()};return{...a,prompt:a?.prompt||"",response:[...a?.response||[],t]}},onSuccess:s=>{x.setQueryData(["AI"],s),localStorage.setItem("AI",JSON.stringify(s))}}),u=m({mutationFn:async({id:s})=>{if(!a||!a?.response)throw new Error("Data is not available");return{...a,response:a?.response?.map(r=>r.id===s?{...r,isNew:!1}:r)}},onMutate:async({id:s})=>{await x.cancelQueries({queryKey:["AI"]});const i=x.getQueryData(["AI"]);return x.setQueryData(["AI"],r=>!r||!r.response?r:{...r,response:r.response.map(t=>t.id===s?{...t,isNew:!1}:t)}),localStorage.setItem("AI",JSON.stringify(x.getQueryData(["AI"]))),i?{previousData:i}:{previousData:w}},onError:(s,i,r)=>{r?.previousData&&(x.setQueryData(["AI"],r.previousData),localStorage.setItem("AI",JSON.stringify(r.previousData)))},onSettled:()=>{x.invalidateQueries({queryKey:["AI"]})}});return{data:a,isLoading:d.status==="pending",getResponse:d.mutate,changeResponseToOld:u.mutate}}function T({text:n,id:l}){const[o,a]=p.useState(""),{changeResponseToOld:d}=N(),u=p.useRef(null);return p.useEffect(()=>{const s=Array.from(n??"");a("");let i=!1;async function r(){for(let t=0;t<s.length&&!i;t++)a(c=>c+s[t]),await new Promise(c=>{u.current=window.setTimeout(c,20)});i||d({id:l})}return r(),()=>{i=!0,u.current!==null&&clearTimeout(u.current)}},[n,l,d]),e.jsx(e.Fragment,{children:o})}function k({children:n}){return I.createPortal(n,document.body)}function R(){const[n,l]=p.useState(""),{user:o,isLoading:a,error:d}=j(),{data:u,isLoading:s,getResponse:i}=N(),r=p.useCallback(()=>{!n||!o.data||(i({prompt:n}),l(""))},[n,o,i]);return p.useEffect(()=>{const t=c=>{c.key==="Enter"&&(c.preventDefault(),r())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[r]),o.nickname===null?e.jsx(f,{message:"You are not logged in. Please log in to see your analytics."}):a?e.jsx(y,{}):d?e.jsx(f,{message:"Something went wrong, please try again"}):o.data?e.jsx("section",{className:"w-full ",children:e.jsxs("div",{className:"relative",children:[e.jsx("h1",{className:"text-[var(--color-title)] transitioned text-[32px] font-semibold mb-6",children:"Analytics"}),e.jsxs("div",{children:[s&&e.jsx("div",{className:"h-30 w-30 overflow-hidden flex justify-center items-center mx-auto",children:e.jsx(y,{})}),u?.response&&[...u.response].reverse().map((t,c)=>{const b=c===0;return e.jsxs(h.div,{className:"",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3,delay:c*.1},children:[e.jsxs("div",{className:"mt-6 text-[var(--color-text)] px-5 py-2 border-1 border-[var(--color-fixed-text)] rounded max-w-[70%] max-sm:max-w-full w-fit items-end ml-auto flex flex-col justify-end",children:[e.jsxs("div",{className:"flex flex-row-reverse items-center gap-3",children:[o&&o.userPhoto&&e.jsx("img",{src:o.userPhoto,className:"w-8 h-8 rounded-full",alt:""}),e.jsx("div",{className:"",children:t.forPrompt})]}),e.jsx("div",{className:"w-full italic text-right mt-3 text-[var(--color-placeholder)]",children:g(new Date(t.date),!0)})]}),e.jsxs("div",{className:"mt-6 text-[var(--color-text)] px-5 py-2 border-1 border-[var(--color-fixed-text)] rounded max-w-[70%] max-sm:max-w-full",children:[b?e.jsx(T,{id:t.id,text:v(t.content)}):e.jsx(e.Fragment,{children:v(t.content)}),e.jsx("div",{className:"w-full italic text-right mt-3 text-[var(--color-placeholder)]",children:g(new Date(t.date),!0)})]})]},t.id)})]}),e.jsx(k,{children:e.jsx(h.div,{initial:{y:100,opacity:0},animate:{y:0,opacity:1},transition:{duration:.4,ease:"easeOut"},className:`fixed z-3 bottom-5 left-[320px] w-[calc(100%-340px)] max-md:left-5 max-md:w-[calc(100%-40px)]
                       bg-[var(--color-card)]  rounded-2xl border-2 border-[var(--color-fixed-text)]
                       shadow-lg`,children:e.jsxs("div",{className:"flex gap-6 my-2 mx-3 justify-between items-center",children:[e.jsx("textarea",{name:"prompt",value:n,onChange:t=>l(t.target.value),placeholder:"Ask me anything...",id:"prompt",className:`w-full max-h-48 h-12 rounded-[5px] p-3 placeholder:text-[var(--color-placeholder)]
                               text-[var(--color-text)] scrollable resize-none transitioned text-[16px] font-semibold
                               focus:outline-none`}),e.jsx("button",{onClick:r,type:"button",disabled:s,className:`w-[120px] h-12 border-1 border-[var(--color-fixed-text)] rounded-[10px] p-3
                               text-[var(--color-text)] cursor-pointer transitioned
                               hover:bg-[var(--color-fixed-text)] hover:text-[var(--color-card)]
                               text-[16px] font-semibold`,children:"Analyze"})]})})})]})}):e.jsx(S,{})}export{R as Analitycs};
